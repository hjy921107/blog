---
title: CentOS_7_软件安装管理
date: 2017-09-17 23:00:56
category: Linux
tags: CentOS 7
---

<!-- toc -->

---

# 1. 软件包的分类

Linux 中只有两种软件包，就是源码包和二进制包

## 1.1 源码包

+ 优点
	- 开源，如果有足够的能力，可以修改源代码；
	- 可以自由选择所需的功能；
	- 软件是编译安装，所以更加适合自己的系统，更加稳定、效率更高；
	- 卸载方便；
+ 缺点
	- 安装过程步骤较多，尤其安装较大的软件集合时（如 LAMP 环境搭建），容易出现拼写错误；
	- 编译过程时间较长，安装比二进制安装时间长；
	- 因为是编译安装，安装过程中一旦报错新手很难解决；

## 1.2 二进制包（RPM 包，也叫系统默认包）

+ 优点
	- 包管理系统简单，只用几个命令就可以实现安装、升级、查询和卸载
	- 安装速度比源码包快多了
+ 缺点
	- 经过编译，不再可以看到源代码
	- 功能选择不如源码包灵活
	- 依赖性

## 1.3 脚本安装包

所谓的脚本安装包，就是把复杂的软件包安装过程写成了程序脚本，初学者可以执行程序脚本实现一键安装，其本质还是安装源码包和二进制包。

优点：安装简单、快捷（和 Windows 下安装软件时的一键安装很类似。）
缺点：完全丧失了自定义性。（在 Windows 下，我们没办法再更改安装路径。）

# 2. rpm 包管理

## 2.1 rpm 包相关

- RPM 包的来源：RPM包在系统光盘的 Packages 目录中
+ RPM 包命名规则：以 httpd-2.2.15-15.el6.centos.1.i686.rpm 为例
	- httpd：软件包名
	- 2.2.15：软件版本
	- 15：软件发布的次数
	- el6.centos：适合的linux平台
	- i686：适合的硬件平台，除 x64，其余 ixxx 都是 32 位
	- rpm：rpm包扩展名
+ RPM 包依赖性
	- 树形依赖：a -> b -> c，对于此依赖，根据提示依次安装即可
	- 环形依赖：a -> b -> c -> a
	- 模块依赖：此依赖表示依赖的是一个库文件，文件名以 “.so” 结尾。此时无法直接通过 rpm 命令安装该库文件，需要通过查询 “www.rpmfind.net” 网站找到含有此库文件的 rpm 包，然后安装查询到的包即可
+ 包全名与包名
	- 包全名：操作的包是没有安装的软件包时，使用包全名，而且需要注意路径，确保系统能找到该包
	- 包名：操作已经安装的软件时（卸载、查询）时，使用包名即可，系统会去 /var/lib/rpm/ 下的数据库中搜索已经安装的对应包

## 2.2 rpm 安装

格式：rpm -ivh 包全名

选项：

- -i(install)：安装
- -v(verbose)：显示详细信息
- -h(hash)：显示进度
- --nodepes：不检测依赖性，强制安装，对于需要安装依赖包的软件，使用此选项是虽能安装软件包，但无法实现功能，所以通常情况下，是不允许使用的。

说明：

- 安装命令并不复杂，主要是需要处理包的依赖性
- 安装过程中第一个 100% 表示准备成功，第二个 100% 表示安装成功
- 由于 rpm 包的安装互相依赖极其繁琐，所以通常会使用 yum 在线安装，但是 yum 安装不能实现 RPM 包的查询以及校验

## 2.3 rpm 升级

格式：rpm -Uvh 包全名

选项：

- -U(upgrade)：升级

说明：

- 升级包对于系统而言，同样是未安装的，所有需要使用的包全名，并且注意包的路径
- 由于是升级，所以新包的版本应该高于旧包
- 对于从未安装的包，此命令也有效，此时功能等价于使用安装命令，即 rpm 的安装也可以使用升级命令

## 2.4 rpm 包卸载

格式：rpm -e 包名

选项：

- -e(erase)：卸载
- --nodeps：不检查依赖性，基本不允许使用

## 2.5 rpm 包查询

### 2.5.1 查询是否安装

- `rpm -q 包名`：查询指定包是否安装，query
- `rpm -qa`：查询所有已安装包，query all

### 2.5.2 查询软件包信息

软件包的信息是包作者提前写到包中的，是一些包的简介，参考价值并不大，不过可以在此信息中找到该包对应的官网，获取更详细的帮助。由于这些信息是提前写好的，所以，无论软件包是否安装，都可以通过此命令查询包的信息

- `rpm -qi 包名`：查询指定已安装包的信息，query information
- `rpm -qip 包名`：查询指定未安装包的信息，query informatio package

### 2.5.3 查询包中文件安装的位置

同软件包的信息类似，软件包文件的安装位置也是包作者提前指定好的，无论软件包是否安装，都可以通过此命令查询包中文件的安装位置。但是，不同的作者，对文件位置的处理并不一致，所以包与包之间会存在一定和差异。

- `rpm -ql 包名`：查询指定已安装包中文件的安装位置，query list
- `rpm -qlp 包名`：查询指定未安装包中文件的安装位置，query　list package

通常情况下 rpm 包的<span id="rpmDefDir">默认安装位置</span>

| 安装目录　|　说明　|
| ------- | ----- |
| /etc/ | 配置文件安装目录　|
| /usr/sbin/ 或 /usr/bin | 软件包中可执行命令的安装目录　|
| /usr/lib | 软件包所需要使用的库文件　|
| /usr/share/doc |　软件包的使用文档保存目录　|
| /usr/share/man |　软件包使用手册的保存目录　|

### 2.5.4 查询系统文件所属的 rpm 包

与上条命令功能相反，此命令是根据文件找到对应的 rpm 包。注意：此的文件必须是通过安装 rpm　生成的。

- `rpm -qf 文件`：查询文件属性于哪个 rpm 软件包，query file

### 2.5.5 查询软件包的依赖性

软件包的依赖性也是由包本身决定，与是否被安装无关，所以，无论软件包是否安装，都可以通过此命令查询包的依赖性。不过，此命令的列出的依赖太过详细，往往会包含一些系统最基本的包、命令、库文件等，而这些都是安装完系统肯定存在的，根本无须用户手动安装，所以，真正需要的依赖包通常都是该命令结果集的子集。

对于包依赖性，更多的是使用 rpm　安装命令，根据提示逐个解决。

- `rpm -qR 包名`： 查询指定的已安装软件包的依赖性
- `rpm -qRp 包名`：查询指定的未安装软件包的依赖性

## 2.6 rpm 包校验

对软件包的安装完成的文件进行校验，判断文件是否被修改

- `rpm -V 包名`：校验指定的已安装的包，verify

说明：

- 该命令执行之后，如果没有任何回馈信息，则表示该　rpm 包下的文件一切正常
+ 执行结果格式举例：`S.5....T.  c /etc/httped/conf/httpd.conf`
       + `S.5....T.`，对应位置存在值，表示文件相关信息被改变
		- S：文件大小是否改变
		- M：文件的类型或文件的权限（rwx）是否被改变
		- 5：文件MD5校验和是否改变（可以看成文件内容是否改变）
		- D：设备的主从代码是否改变
		- L：文件路径是否改变
		- U：文件的属主（所有者）是否改变
		- G：文件的属组是否改变
		- T：文件的修改时间是否改变
       + `c`，表示文件类型
		- c：配置文件（config file）
		- d：普通文档（documentation）
		- g：“鬼”　文件（ghost file），很少见，就是该文件不应该被这个　RPM　包中；
		- L：授权文件（license file）
		- r：描述文件（read me）

## 2.7 rpm 包文件提取

从 rpm 包中提取需要文件，通常用于因为误操作删除了一些系统文件导致某些功能无法使用，此时需要从对应的 rpm 包中找到被误删除的文件，并拷贝到对应目录下来使功能正常使用，当然也可以直接重新安装该 rpm 软件包。

+ `rpm2cpio 包全名 ｜ cpio -idv .文件/目录绝对路径`
	- rpm2cpip：将 rpm 包格式转换为 cpio 格式
	+ cpip：一个标准工具，它用于创建软件档案文件并从档案文件中提取文件
		- 命令格式：cpio 选项 目标文件/目录 < 档案文件源
		+ 选项：
			- -i：copy-in模式，还原/解压
			- -d：还原时自动新建需要的目录
			- -v：列出处理的文件/目录

说明：

- rpm2cpio 后指定软件包使用的包全名
- cpio 命令只指定了需要抽取的目的文件，所以对于档案文件源需要使用重定向符或者管道命令来指定
- 对于抽取的目的文件/目录，必须使用绝对路径名，该绝对路径名必须能够使用 `rpm -ql [全]包名` 命令在对应的 rpm 包软件安装位置中找到，而且，绝对路径名之前的 `.` 不能省略，代表将找到的文件复制到当前目录下
- 如果抽取成功，会在执行后输出命令中指定的 ”.绝对路径“ 以及 blocks 数量，否则，只输出 blocks 数量

通过以上步骤就可以从 rpm 包中抽取需要的文件/目录，然后将文件/目录保存到对应的目录，即可还原系统功能。

# 3. yum 在线安装

yum 是 redhat 提供的在线安装工具，用于解决 rpm 安装中依赖性的问题，但其本质还是安装的 rpm 软件包，并且 yum 注重的是安装，对于包的查询、校验等并未提供很好的支持，所以，此时还是需要使用 rpm 来进行包的管理。

## 3.1 yum 配置文件

通过如下命令查看 yum 的配置文件：`ls /etc/yum.repos.d/CentOS-*.repo`，默认情况下，有如下文件：

```shell
CentOS-Base.repo  CentOS-Debuginfo.repo  CentOS-Media.repo    CentOS-Vault.repo
CentOS-CR.repo    CentOS-fasttrack.repo  CentOS-Sources.repo
```

上述配置文件的结构、内容基本相似，其中，系统默认以 CentOS-Base.repo 作为基本配置文件，文件内容大致说明如下：

- [base]：容器名称，一定要放在 `[]` 中
- name：容器说明，可以自己随意填写
- mirrorlist：镜像站点，默认是国外的，相对速度较慢，可以自行修改为国内可用镜像
- baseurl：yum 源服务器的地址，默认是 CentOS 官方的 yum 源服务器，此参数和 mirrorlist 是主备关系，使用其一即可，同样此参数可以自行修改为国内可用地址
- enabled：此容器是否生效，如果省略或设置为 1，即默认值，否则设为 0，即不生效
- gpgcheck：如果是 1 是指 RPM 的数字证书生效，如果是 0 则不生效，建议启用
- gpgkey：数字证书的公钥文件保存位置，不用修改

## 3.2 yum 本地安装

对于无法联网、追求快速安装、无须最新版本的情况，可以搭建 yum 的本地安装环境，通过会使用系统盘作为 yum 软件包源，下面简要说明使用光盘搭建本地 yum 的方法。

1. 将含有 rpm 包的光盘挂载到系统，此处使用的挂载目录为：`/media/cdrom`
2. 取消系统默认的 yum 网络安装配置，可以使用 `enabled=0` 将 CentOS-Base.repo 文件中的所有容器设置成不生效，或者直接删除此文件（不建议），推荐修改此文件的文件名，如 CentOS-Base.repo.bak
3. 启用 yum 光盘安装配置，即修改 CentOS-Media.repo 文件内容
	- 启用窗口，`enabled=1`
	- 修改窗口的 baseurl 为光盘的挂载目录

通过以上步骤就搭建好了 yum 的本地安装环境，可以通过 `yum list` 命令查询本地 yum 中的 rpm 包列表，此时，会先更新本地 yum 数据库信息，如果列出的 Available Packages 的容器名与 CentOS-Media.repo 中配置的容器名一致，说明 yum 本地安装环境搭建成功。

## 3.3 yum 命令

格式：yum [选项] 命令 [参数]

常用 yum 命令：

+ `yum list [命令] [参数]`
	- `yum list`：列出当前 yum Repository 中所有可用的软件包
	- `yum list 包名`：列出当前 yum Repository 中指定软件包
	- `yum list installed`：列出当前系统已安装的软件包
	- `yum list extras`：列出当前已安装但不在 Yum Repository 內的软件包
	- `yum list updates`：列出当前系统中可更新的软件包
+ `yum info [命令] [参数]`
	- `yum info`：列出当前 yum Repository 中所有软件包的信息
	- `yum info 包名`：列出当前 yum Repository 中指定的软件包信息
	- `yum info installed`：列出当前系统已安装软件的信息
	- `yum info extras`：列出当前系统中已安装但不再 yum Repository 中的软件包信息
	- `yum info updates`：列出当前系统中可更新的软件包信息
- `yum check-update`：列出可更新的软件包列表
- `yum provides 关键字`：从当前 yum Repository 中查找包含该关键字（包名、库文件...）的 rpm 软件包
- `yum search 关键字`：按照关键字从当前 yum Repository 中查找匹配的软件包
- `yum deplist 包名`：查看包的依赖
- `yum repolist`：查看当前生效的 yum 源
+ `yum -y 命令 [包名]`
	- -y：选项，表示在整个 yum 命令的执行过程中，对于系统的询问，总是回答 yes
	+ 常用命令
		- 安装：`yum -y install 包名`
		- 升级：`yum -y update 包名`，如果省略包名，会升级所有包，包括系统内核程序，耗时长，内核程序的升级容易导致系统崩溃
		- 卸载：`yum -y remove 包名`，yum 的卸载同安装一样，会自动处理依赖性问题，即自动卸载相关的包、库文件等，容易导致系统崩溃，所以不建议使用 yum 进行卸载
	+ 软件组管理命令（类似于相关软件的打包安装）
		- `yum grouplist`：列出当前 yum 源可用的软件组列表
		- `yum groupinstall`：安装指定的软件组名，组名必须为英文，如果系统为中文，可使用 `LANG=en_US.UTF-8` 来临时切换系统语言
		- `yum groupremove`：卸载指定软件组
	- `yum localinstall`：安装本地 yum 源
- `yum --downloadonly --downloaddir=DLDIR`：只下载 rpm 包，不安装。不指定下载目录，默认下载到 yum 的缓存目录中

## 3.4 yum 缓存

缓存目录：/var/cache/yum/

+ 清除 yum 缓存
	- `yum clean all`：清除缓存目录下的所有内容（packages、headers、plugins 等）
	- `yum clean packages`：清除缓存目录下的所有 packages
	- `yum clean headers`：清除缓存目录下的所有 headers

## 3.5 yum 配置文件

配置文件地址：`/etc/yum.conf`，其中配置了 yum 的默认缓存目录，是否开启缓存等配置，默认情况下，yum 不缓存（keepcache=0）

## 3.4 源码包安装

### 3.4.1 源码包和 rpm 的区别

- 基本概念上的区别前面已经说明，此处不再赘述
+ 主要是安装位置上的区别
	- rpm 包：默认情况下，rpm 是有基本统一的安装位置的，由该软件包的作者指定，详见：[rpm 默认安装位置](#rpmDefDir)；同时 rpm 的安装软件包也可以手动指定安装位置，使用如下选项 `--prefix=<dir>`，但并不建议手动指定，通常情况下软件包作者配置的安装目录都是按照 Linux 目录的功能进行分配的，对于可执行命令都会安装到 PATH 指定的目录下，系统会提供一些便捷的调用方式，如果自定义，则需要手动配置。
	- 源码包：安装位置由用户手动指定，通过情况下建议安装在 /usr/local/，此目录类似于 windows 下的 Program Fils，此时，对于软件包提供的一些可执行命令必须使用绝对路径来调用

### 3.4.2 安装

以 apache 的 httpd 为例：

1. 下载源码包：`wget http://mirrors.cnnic.cn/apache//httpd/httpd-2.4.23.tar.gz`，建议保存位置：`/usr/local/src`，以下操作均在此目录下执行
2. 解压源码包：`tar -xvf httpd-2.4.23.tar.gz`
3. 进入解压目录：`cd httpd-2.4.23`
4. 查看 INSTALL 文件，该文件说明了安装、配置和启动命令，主要如下：
	1. 安装前准备：`./configure --prefix=path...` ，进行 httpd 的基本配置和安装环境检查
		- `--prefix=/usr/local/apache2.4`：指定安装位置，建议必选
		- `--help`：查看相关配置帮助
		- 此命令的配置会在安装完成后保存在 MAKEFILE 文件中
	2. 编译：`make`
	3. 安装：`make install`
	4. 启动：`/usr/local/apache/bin/apachectl start`，stop 为关闭

一般而言，源码包的安装基本有上述几步：

1. 下载源码包
2. 解压源码包
3. 进入解压目录（必选，因为安装命令都是在解压包中的，所以必须进入此目录，否则安装命令就需要使用绝对路径调用）
4.安装
	1. 检查安装环境，进行软件包的基本配置
	2. make，编译需要 gcc 包的支持，如果编译失败，可通过 `make clean` 来撤消
	3. make install
		- 通常情况下，只有在安装过程完全结束，此时如果最后部分安装说明出现错误，才可确定为安装失败，对于安装过程中的错误，一般可以忽略
		- 如果安装失败，需要手动删除安装目录，然后根据错误说明解决问题后重新安装；在编译期出现错误时，因为还未生成安装目录，所以根本不存在删除安装目录之说
	4. 启动
